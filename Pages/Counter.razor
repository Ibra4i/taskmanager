@page "/counter"
@using taskManager.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<ApplicationDbContext> ContextFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]
<PageTitle>Task Manager</PageTitle>

<h1 class="my-4">Task Manager</h1>

<div class="card mb-4">
    <div class="card-header">
        Add New Task
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-12 col-md-3 mb-2 mb-md-0">
                <select @bind="selectedDefaultTask" class="form-select stylish-dropdown">
                    <option value="">Select a default task</option>
                    <option value="Laundry">Laundry</option>
                    <option value="Do Dishes">Do Dishes</option>
                    <option value="Clean the Toilet">Clean the Toilet</option>
                    <option value="Støvsuge">Støvsuge</option>
                    <option value="Making Lunch">Making Lunch</option>
                    <option value="Shopping for Grocery">Shopping for Grocery</option>
                </select>
            </div>
            @if (string.IsNullOrWhiteSpace(selectedDefaultTask))
            {
                <div class="col-12 col-md-3 mb-2 mb-md-0">
                    <input @bind="newTask" class="form-control" placeholder="Enter a new task" />
                </div>
            }
            <div class="col-12 col-md-3 mb-2 mb-md-0">
                <input @bind="newAssignee" class="form-control" placeholder="Assignee" />
            </div>
            <div class="col-12 col-md-3 mb-2 mb-md-0">
                <input type="date" @bind="newDueDate" class="form-control" />
            </div>
            <div class="col-12 col-md-3 mb-2 mb-md-0">
                <select @bind="newCategory" class="form-select">
                    <option value="">Select a category</option>
                    <option value="Daily">Daily</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Monthly">Monthly</option>
                </select>
            </div>
            <div class="col-12 col-md-3">
                <button class="btn btn-primary w-100" @onclick="addTask">Add Task</button>
            </div>
        </div>
    </div>
</div>

<h2>Daily Tasks</h2>
<ul class="list-group mb-4">
    @foreach (var task in tasks.Where(t => t.Category == "Daily" && !t.IsCompleted))
    {
        <li class="list-group-item d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <input type="checkbox" class="form-check-input me-2" @onchange="() => MarkTaskAsCompleted(task)" />
                    @if (task.IsEditing)
                    {
                        <input @bind="task.Name" class="form-control me-2" />
                        <input @bind="task.Assignee" class="form-control me-2" />
                        <input type="date" @bind="task.DueDate" class="form-control me-2" />
                        <select @bind="task.Category" class="form-select me-2">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                        <button class="btn btn-success btn-sm" @onclick="() => SaveTask(task)">Save</button>
                    }
                    else
                    {
                        <span class="task-name @(task.IsCompleted ? "completed" : "")">@task.Name</span>
                        <span class="assignee ms-2">(@task.Assignee)</span>
                        <span class="due-date ms-2">Due: @GetDueDateText(task.DueDate)</span>
                        <button class="btn btn-secondary btn-sm me-2" @onclick="() => EditTask(task)">Edit</button>
                    }
                </div>
                <button class="btn btn-danger btn-sm" @onclick="() => RemoveTask(task)">Delete</button>
            </div>
            <small class="text-muted">Created on: @task.CreationTime.ToString("g")</small>
        </li>
    }
</ul>

<h2>Weekly Tasks</h2>
<ul class="list-group mb-4">
    @foreach (var task in tasks.Where(t => t.Category == "Weekly" && !t.IsCompleted))
    {
        <li class="list-group-item d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <input type="checkbox" class="form-check-input me-2" @onchange="() => MarkTaskAsCompleted(task)" />
                    @if (task.IsEditing)
                    {
                        <input @bind="task.Name" class="form-control me-2" />
                        <input @bind="task.Assignee" class="form-control me-2" />
                        <input type="date" @bind="task.DueDate" class="form-control me-2" />
                        <select @bind="task.Category" class="form-select me-2">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                        <button class="btn btn-success btn-sm" @onclick="() => SaveTask(task)">Save</button>
                    }
                    else
                    {
                        <span class="task-name @(task.IsCompleted ? "completed" : "")">@task.Name</span>
                        <span class="assignee ms-2">(@task.Assignee)</span>
                        <span class="due-date ms-2">Due: @GetDueDateText(task.DueDate)</span>
                        <button class="btn btn-secondary btn-sm me-2" @onclick="() => EditTask(task)">Edit</button>
                    }
                </div>
                <button class="btn btn-danger btn-sm" @onclick="() => RemoveTask(task)">Delete</button>
            </div>
            <small class="text-muted">Created on: @task.CreationTime.ToString("g")</small>
        </li>
    }
</ul>

<h2>Monthly Tasks</h2>
<ul class="list-group mb-4">
    @foreach (var task in tasks.Where(t => t.Category == "Monthly" && !t.IsCompleted))
    {
        <li class="list-group-item d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <input type="checkbox" class="form-check-input me-2" @onchange="() => MarkTaskAsCompleted(task)" />
                    @if (task.IsEditing)
                    {
                        <input @bind="task.Name" class="form-control me-2" />
                        <input @bind="task.Assignee" class="form-control me-2" />
                        <input type="date" @bind="task.DueDate" class="form-control me-2" />
                        <select @bind="task.Category" class="form-select me-2">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                        <button class="btn btn-success btn-sm" @onclick="() => SaveTask(task)">Save</button>
                    }
                    else
                    {
                        <span class="task-name @(task.IsCompleted ? "completed" : "")">@task.Name</span>
                        <span class="assignee ms-2">(@task.Assignee)</span>
                        <span class="due-date ms-2">Due: @GetDueDateText(task.DueDate)</span>
                        <button class="btn btn-secondary btn-sm me-2" @onclick="() => EditTask(task)">Edit</button>
                    }
                </div>
                <button class="btn btn-danger btn-sm" @onclick="() => RemoveTask(task)">Delete</button>
            </div>
            <small class="text-muted">Created on: @task.CreationTime.ToString("g")</small>
        </li>
    }
</ul>

<div class="completed-tasks">
    <h5 @onclick="ToggleCompletedTasks">Completed Tasks</h5>
    @if (showCompletedTasks)
    {
        <ul class="list-group">
            @foreach (var task in completedTasks)
            {
                <li class="list-group-item">
                    <span class="task-name completed">@task.Name</span>
                    <span class="assignee ms-2">(@task.Assignee)</span>
                    <span class="due-date ms-2">Due: @GetDueDateText(task.DueDate)</span>
                    <span class="completion-time ms-2">Completed on: @task.CompletionTime?.ToString("g")</span>
                </li>
            }
        </ul>
    }
</div>

<button class="btn btn-secondary btn-sm me-2" @onclick="() =>DeleteTasks()">Clear</button>

<div class="ranking">
    <h5>Task Completion Ranking</h5>
    <ul class="list-group">
        @foreach (var rank in GetTaskCompletionRanking())
        {
            <li class="list-group-item ranking-item" @key="rank.Assignee">
                <span>
                    @rank.Assignee: @rank.CompletedTasks tasks completed @if (rank.Streak > 1)
                    {
                        <span>🔥 @rank.Streak</span>
                    }
                </span>
                <div>
                    Daily: @rank.DailyTasks, Weekly: @rank.WeeklyTasks, Monthly: @rank.MonthlyTasks
                </div>
            </li>
        }
    </ul>
</div>

<style>
    .completed {
        text-decoration: line-through;
        color: gray;
    }

    .stylish-dropdown {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        color: #495057;
    }

        .stylish-dropdown:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

    .completed-tasks {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 300px;
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 1rem;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000; /* Ensure it appears above other content */
    }

        .completed-tasks h5 {
            margin-bottom: 1rem;
            cursor: pointer;
        }

    .ranking {
        margin-top: 2rem;
    }

        .ranking h5 {
            margin-bottom: 1rem;
        }

    .ranking-item {
        transition: transform 0.3s ease-in-out, background-color 0.3s ease-in-out;
    }

        .ranking-item.streak {
            background-color: #ffeb3b;
            transform: scale(1.05);
        }

        .ranking-item.rank-up {
            background-color: #4caf50;
            transform: scale(1.1);
        }
</style>

@code {
    private string newTask;
    private string newAssignee;
    private DateTime newDueDate = DateTime.Today;
    private string selectedDefaultTask;
    private string newCategory = "Daily";
    private string newImageUrl = "default.jpg"; // Add a default image URL
    private string newDescription = "Default Description"; // Add a default description
    private List<TaskItem> tasks = new();
    private List<TaskItem> completedTasks = new();
    private string lastCompletedAssignee;
    private int currentStreak;
    private bool showCompletedTasks = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
    }

    private async Task addTask()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userName = user.Identity.Name;
            var taskName = !string.IsNullOrWhiteSpace(selectedDefaultTask) ? selectedDefaultTask : newTask;

            if (!string.IsNullOrWhiteSpace(taskName) && !string.IsNullOrWhiteSpace(newAssignee) && !string.IsNullOrWhiteSpace(newCategory))
            {
                using (var context = ContextFactory.CreateDbContext())
                {
                    var task = new TaskItem
                        {
                            Name = taskName,
                            Assignee = newAssignee,
                            Description = newDescription, // Provide a value for the Description property
                            ImageUrl = newImageUrl, // Provide a value for the ImageUrl property
                            CreationTime = DateTime.Now,
                            DueDate = newDueDate,
                            Category = newCategory,
                            Streak = 0, // Initialize the streak to 0
                            UserId = userName // Set the UserId to the logged-in user's name
                        };
                    context.Tasks.Add(task);
                    context.SaveChanges();
                    tasks.Add(task);
                }
                newTask = string.Empty;
                newAssignee = string.Empty;
                newDueDate = DateTime.Today;
                selectedDefaultTask = string.Empty;
                newCategory = "Daily";
                newImageUrl = "default.jpg"; // Reset the image URL
                newDescription = "No Description"; // Reset the description
            }
        }
    }

    private void RemoveTask(TaskItem task)
    {
        using (var context = ContextFactory.CreateDbContext())
        {
            context.Tasks.Remove(task);
            context.SaveChanges();
            tasks.Remove(task);
        }
    }

    private void EditTask(TaskItem task)
    {
        task.IsEditing = true;
    }

    private void SaveTask(TaskItem task)
    {
        using (var context = ContextFactory.CreateDbContext())
        {
            context.Tasks.Update(task);
            task.IsEditing = false;
            context.SaveChanges();
        }
    }

    private void MarkTaskAsCompleted(TaskItem task)
    {
        using (var context = ContextFactory.CreateDbContext())
        {
            task.IsCompleted = true;
            task.CompletionTime = DateTime.Now; // Set the completion time
            context.Tasks.Update(task);
            context.SaveChanges();
            tasks.Remove(task);
            completedTasks.Add(task);

            if (lastCompletedAssignee == task.Assignee)
            {
                currentStreak++;
            }
            else
            {
                lastCompletedAssignee = task.Assignee;
                currentStreak = 1;
            }

            task.Streak = currentStreak;
            context.Tasks.Update(task);
            context.SaveChanges();
        }
    }

    private string GetDueDateText(DateTime dueDate)
    {
        var daysDifference = (dueDate - DateTime.Today).Days;

        return daysDifference switch
        {
            0 => "Today",
            1 => "Tomorrow",
            -1 => "Yesterday",
            -2 => "Two days ago",
            _ => daysDifference > 0 ? $"In {daysDifference} days" : $"{Math.Abs(daysDifference)} days ago"
        };
    }

    private IEnumerable<(string Assignee, int CompletedTasks, int Streak, int DailyTasks, int WeeklyTasks, int MonthlyTasks)> GetTaskCompletionRanking()
    {
        return completedTasks
            .GroupBy(task => task.Assignee)
            .Select(group => (
                Assignee: group.Key,
                CompletedTasks: group.Count(),
                Streak: group.Max(task => task.Streak),
                DailyTasks: group.Count(task => task.Category == "Daily"),
                WeeklyTasks: group.Count(task => task.Category == "Weekly"),
                MonthlyTasks: group.Count(task => task.Category == "Monthly")
            ))
            .OrderByDescending(rank => rank.CompletedTasks)
            .ThenByDescending(rank => rank.Streak);
    }

    private void ToggleCompletedTasks()
    {
        showCompletedTasks = !showCompletedTasks;
    }

    private async Task LoadTasks()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userName = user.Identity.Name;

            using (var context = ContextFactory.CreateDbContext())
            {
                tasks = await context.Tasks
                    .Where(t => !t.IsCompleted && t.UserId == userName)
                    .ToListAsync();

                completedTasks = await context.Tasks
                    .Where(t => t.IsCompleted && t.UserId == userName)
                    .ToListAsync();
            }
        }
    }

    private void DeleteTasks()
    {
        using (var context = ContextFactory.CreateDbContext())
        {
            tasks = context.Tasks.Where(t => !t.IsCompleted).ToList();
            completedTasks = context.Tasks.Where(t => t.IsCompleted).ToList();
            context.Tasks.RemoveRange(context.Tasks);
            context.SaveChanges();
            tasks.Clear();
            completedTasks.Clear();
        }
    }
}
